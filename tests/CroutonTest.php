<?php
/**
 * Created by PhpStorm.
 * User: Dymko
 * Date: 8/17/16
 * Time: 8:09 PM
 */

namespace kaktus\Tests;

use kaktus\Crouton\Crouton;
use kaktus\Crouton\crud\Write;

class CroutonTest extends \PHPUnit_Framework_TestCase
{
    public function setUp()
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        if(!file_exists('/etc/cron.d/crouton'))
        {
            $fh = fopen('/etc/cron.d/crouton', 'w') or die("Can't create file");
            chmod('/etc/cron.d/crouton', 0777);
            fwrite($fh, "#Crouton Cron Entry\n");
        }

    }

    public function testWrite()
    {

        $crouton = new Crouton();
        $crouton->write('1', "12:34", "18:21", "/etc/cron.d/crouton");

        $write = new Write('/etc/cron.d/crouton');
        $cron = $write->cron_creator('1', "12:34", "18:21", "/etc/cron.d/crouton");

        $handle = fopen('/etc/cron.d/crouton','r');
        $data = fread($handle,filesize('/etc/cron.d/crouton'));

        $cron = preg_replace('/\*/', '\*', $cron);
        $cron = preg_replace('/\//', '\/', $cron);
        $cron = "/$cron/";

        $this->assertRegExp($cron, $data);

    }

    public function testCronCreator()
    {
        $crouton = new Write('/etc/cron.d/crouton');
        $cron_test = $crouton->cron_creator('1,4,5,7', "02:34", "12:12", "/etc/cron.d/crouton");
        $cron_test = preg_replace('/\*/', '\*', $cron_test);
        $cron_test = preg_replace('/\//', '\/', $cron_test);
        $cron_test = "/$cron_test/";

        $this->assertRegExp($cron_test, '5 02-12 * * 1,4,5,7 /etc/cron.d/crouton');


        $cron_test = $crouton->cron_creator('1,4,5,7', "02:34", "12:12", "/etc/cron.d/crouton", "php");
        $cron_test = preg_replace('/\*/', '\*', $cron_test);
        $cron_test = preg_replace('/\//', '\/', $cron_test);
        $cron_test = "/$cron_test/";

        $this->assertRegExp($cron_test, '5 02-12 * * 1,4,5,7 php /etc/cron.d/crouton');

    }
}